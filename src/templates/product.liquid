{%- assign fe_img = product.selected_or_first_available_variant.featured_image | default: product.featured_image -%}

<section fe-img="{{ fe_img }}" data-section-id="{{ section.id }}" data-section-type="product" data-pdp-product-id="{{ product.id }}" data-single-product="{{ product.id }}">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="pdp-content d-lg-none relative">
          <div class="row no-gutters">
            <div class="col-md-12 col-7">
              <h1 class="pdp-content__title">{{ product.title }}</h1>
            </div>
            <div class="col-md-12 col-4">
              <div class="pdp-content__reviews">
                <span class="stamped-product-reviews-badge" data-id="{{ product.id }}">{{ product.metafields.stamped.badge }}</span>
              </div>
            </div>
            <div class="col-1 d-sm-none static">
              {% section 'pdp-sizes-dropdown' %}
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-7">
        {% if product.handle contains 'extra-vitabead-diffusers' %}
        <!-- diffuser product
        <div style="display:none">
          <ul>
          {% for img in product.images %}
            <li> {{ img | img_url: '500x' }}</li>
          {% endfor %}
          </ul>
        </div>
         -->
        {%- assign current_variant = product.selected_or_first_available_variant -%}
        {%- assign featured_image = current_variant.featured_image | default: product.featured_image -%}
        <div id="shopify-section-pdp-gallery" class="shopify-section pdp-gallery">
          <div class="pdp-gallery__images">
            {% for img in product.images %}

              {% unless img.alt contains "featured-collection-image" or img.alt contains "featured-collection-image-2" %}
                {% assign img_color = "" %}
                {% if img.alt contains "color:" %}
                  {% assign img_alt_split_at_color = img.alt | split: 'color:'  %}
                  {% assign img_color = img_alt_split_at_color[1] | strip %}
                {% endif %}
                {%- capture wrapper_class -%}pdp-gallery__img-wrap{%- endcapture -%}
                {%- capture wrapper_attributes -%}data-product-image-wrapper{% if img_color.size > 0 %} data-gallery-image-color="{{- img_color -}}"{% endif %}{%- endcapture -%}

                <div
                  class="pdp-gallery__image-item"
                  data-color="{{- img_color -}}"
                  img-src="{{ img | img_url: '500x'  }}">
                  {% render 'responsive-image' with
                    image: img,
                    max_width: 500,
                    max_height: 500,
                    image_attributes: "data-product-featured-image",
                    wrapper_class: wrapper_class,
                    image_class: "pdp-gallery__img",
                    wrapper_attributes: wrapper_attributes,
                    snippet_index: 39,
                  %}
                </div>
              {% endunless %}
            {% endfor %}
          </div>
        </div>
        <div id="shopify-section-pdp-gallery-index" class="shopify-section pdp-g-index">
          <div class="pdp-g-index__dots-wrap d-none d-md-block">
            <div class="pdp-g-index__dots" data-pdp-gallery-index>
              {% for imga in product.images %}
               {% assign img_color = "" %}
                {% if imga.alt contains "color:" %}
                  {% assign img_alt_split_at_color = imga.alt | split: 'color:'  %}
                  {% assign img_color = img_alt_split_at_color[1] | strip %}
                {% endif %}
                  <button class="pdp-g-index__dot-link" type="button" data-color="{{- img_color -}}">
					<img src="{{ imga | img_url: '100x' }}" >
                  </button>
              {% endfor %}
            </div>
          </div>
        </div>
        {% else %}
        <!-- Other Products -->
        {% section 'pdp-gallery' %}
        {% section 'pdp-gallery-index' %}
        {% endif %}

      </div>

      <div class="col-lg-5">

        {% section 'pdp-content' %}

        {% assign show_diffuser_form = false %}
        {% if settings.extra_diffusers_show_where contains product.id %}
          {% assign show_diffuser_form = true %}
        {% endif %}
        {% if settings.extra_diffusers_product == product.handle %}
          {% render 'subscription-form' with settings.extra_diffusers_product
            current_product_id: product.id
            show_extras: true,
            note: settings.extra_diffusers_note,
            index: 8,
          %}
        {% else %}
          {% section 'pdp-form' %}
        {% endif %}

        {% if show_diffuser_form %}
          {% unless settings.extra_diffusers_product == product.handle %}
            {% render 'subscription-form' with settings.extra_diffusers_product
              current_product_id: product.id
              show_extras: false,
              title: settings.extra_diffusers_title,
              note: settings.extra_diffusers_note
              hide_price: true
              index: 9,
            %}
          {% endunless %}
        {% endif %}

      </div>
    </div>
  </div>

  {% section 'pdp-usps' %}

  {% section 'pdp-video' %}

  <div class="pdp-tabs" data-tab-container>
    <div id="pdp-tabs-anchor"></div>
    {% section 'pdp-tabs-header' %}

    <div class="pdp-tab-1 active" data-tab=0>
      {% section 'pdp-tab-features' %}
    </div>

    <div class="pdp-tab-2" data-tab=1 style="display:none">
      {% section 'pdp-tab-included' %}
    </div>

    <div class="pdp-tab-3" data-tab=2 style="display:none">
      {% section 'pdp-tab-specs' %}
    </div>

  </div>

  {% section 'pdp-related' %}

  {% section 'pdp-faqs' %}

  {% section 'pdp-reviews' %}

  {% section 'pdp-user-images' %}

  {% render 'diffuser-modal' %}

  {% render 'diffuser-sub-modal' %}

  {% render 'atc-bar' %}

  <input type="hidden" data-current-product-id value="{{ product.id }}" />

  <script type="application/ld+json" data-pdp-product-json>
    {{ product | json }}
  </script>
  <script type="application/ld+json" data-pdp-product-options>
    {{ product.options_with_values | json }}
  </script>

</section>

<script type="text/javascript">
$( '.pdp-form__submit' ).click(function() {
fbq('track', 'AddToCart', {
    value: {{ product.price | money_without_currency }},
    currency: '{{ shop.currency }}',
    content_ids: '[{{ product.id }}]',
	content_name: '{{ product.title }}',
	content_type: 'product_group',
  });
</script>

<script type="application/ld+json">
{
  "@context": "http://schema.org/",
  "@type": "Product",
  "name": "{{ product.title | escape }}",
  "url": "{{ shop.url }}{{ product.url }}",
  {% if product.featured_image %}
    {% assign image_size = product.featured_image.width | append: 'x' %}
    "image": [
      "https:{{ product.featured_image.src | img_url: image_size }}"
    ],
  {% endif %}
  "description": {{ product.description | json }},
  {% if current_variant.sku != blank %}
    "sku": "{{ current_variant.sku }}",
  {% endif %}
  "brand": {
    "@type": "Thing",
    "name": "{{ product.vendor | escape }}"
  },
  {% if product.variants %}
    "offers": [
      {% for variant in product.variants %}
        {
          "@type" : "Offer",
          "availability" : "http://schema.org/{% if product.available %}InStock{% else %}OutOfStock{% endif %}",
          "price" : "{{ variant.price | divided_by: 100.00 }}",
          "priceCurrency" : "{{ shop.currency }}",
          "url" : "{{ shop.url }}{{ variant.url }}",
          "itemOffered" :
          {
              "@type" : "Product",
              {% if variant.image %}
                {% assign variant_image_size = variant.image.width | append: 'x' %}
                "image": "http:{{ variant.image.src | img_url: variant_image_size }}",
              {% endif %}
              {% if variant.title != blank %}
                "name" : "{{ variant.title | escape }}",
              {% endif %}
              {% if variant.sku != blank %}
                "sku": "{{ variant.sku }}",
              {% endif %}
              {% if variant.weight != blank %}
                "weight": {
                  "@type": "QuantitativeValue",
                  {% if variant.weight_unit != blank %}
                    "unitCode": "{{ variant.weight_unit }}",
                  {% endif %}
                  "value": "{{ variant.weight | weight_with_unit: variant.weight_unit }}"
                },
              {% endif %}
              "url": "{{ shop.url }}{{ variant.url }}"
          }
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ]
  {% endif %}
}
</script>
