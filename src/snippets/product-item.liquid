{% assign block_p = product-item %}
{% assign block_p_def_v = block_p.selected_or_first_available_variant %}
{% assign block_p_img = "" %}
{% assign block_p_colors = "" %}
{% assign color = "" %}
{% assign color_classes = "" %}

{% for option in block_p.options_with_values %}
  {% if option.name == "Color" %}
    {% for value in option.values %}
      {% assign block_p_colors =  block_p_colors  | append: value | append: ',' %}
    {% endfor %}
    {% break %}
  {% endif %}
{% endfor %}

{% assign b_p_colors_array = block_p_colors | split: ',' %}
{% for color in b_p_colors_array %}
  {% assign color_class = value %}
  {% assign color_classes = color_classes | append: color | append: 'string' %}
{% endfor %}

<div
  class="product-item{% if block_p.has_only_default_variant %} single{% endif %}"
  data-pi-item
  data-pi-static-class="product-item{% if block_p.has_only_default_variant %} single{% endif %}">
  {% form 'product', block_p, data-product-form: '', data-product-handle: block_p.handle, class: "product-item__form" %}

    <input type="hidden" id="{{ block_p.id }}-quantity" name="quantity" value="1" min="1" />

    {% if block_p.has_only_default_variant %}
      <input type="hidden" name="id" value="{{ block_p_def_v.id }}" />
    {% else %}
      <select name="id" style="display:none !important;" data-pi-variant-select>
        {% for p_i_variant in block_p.variants %}
          <option value="{{ p_i_variant.id }}"
            {% unless p_i_variant.available %}disabled="disabled"{% endunless %}
            {% if forloop.first %}selected="selected"{% endif %}>
            {{ p_i_variant.title }}
          </option>
        {% endfor %}
      </select>
    {% endif %}

    <a
      class="product-item__image-link"
      href="{{ block_p.url }}"
      title="{{ 'products.product.view_details' | t }}">
      <span class="product-item__gallery" data-pi-image-gallery>
        {% assign first = true %}
        {% for color in b_p_colors_array %}
          {% assign color_satisfied = false %}
          {% for block_p_img in block_p.images %}
            {% unless color_satisfied  %}
              {% if block_p_img.alt contains color %}

                {% if first %}
                  {% assign gallery_attribute = 'data-pi-image="' | append: color  | append: '"' %}
                  {% assign gallery_wrapper = "active product-item__g-img-wrap" %}
                {% else %}
                  {% assign gallery_attribute = 'style="display:none;"' | append: 'data-pi-image="' | append: color  | append: '"' %}
                  {% assign gallery_wrapper = "product-item__g-img-wrap" %}
                {% endif %}

                {% render 'responsive-image' with
                  image: block_p_img,
                  max_width: 300,
                  max_height: 450,
                  wrapper_class: gallery_wrapper,
                  image_class: "product-item__gallery-img",
                  wrapper_attributes: gallery_attribute,
                  span: true
                %}

                {% assign first = false %}
                {% assign color_satisfied = true %}
              {% endif %}
            {% endunless %}
          {% endfor %}
        {% endfor %}
      </span>

      <h3 class="product-item__title">
        {{ block_p.title }}
      </h3>

      {% for tag in block_p.tags %}
        {% if tag contains "size-" %}
          <span class="product-item__subtitle" data-pi-option-size="{{ tag }}">
            {{ tag | remove: 'size-' }}
          </span>
          {% break %}
        {% endif %}
      {% endfor %}

      {% for tag in block_p.tags %}
        {% if tag contains "mouth-" %}
          <span class="hide" data-pi-option-mouth="{{ tag }}">
            {{ tag | remove: 'mouth-' }}
          </span>
          {% break %}
        {% endif %}
      {% endfor %}

      <span class="product-item__price">
        <span data-pi-price>
          {{ block_p_def_v.price | money | remove: ".00" | strip }}
        </span>
        <s data-pi-compare>
          {% if block_p_def_v.compare_at_price > block_p_def_v.price %}
            {{ block_p_def_v.compare_at_price | money | remove: ".00" | strip }}
          {% endif %}
        </s>
      </span>
    </a>

    <div class="product-item__hover">
      {% unless block_p.has_only_default_variant %}
      <div class="product-item__options">
        {% for option in block_p.options_with_values %}
          <span class="product-item__options-label">{{ 'products.product.select_html' | t: option: option.name }}</span>
          {% assign name_clean = option.name | downcase %}
          {% if name_clean == "color" %}
            <div class="product-item__colors" data-pi-color-options data-pi-option-color="{{ forloop.index }}">
              {% for value in option.values %}
              {% assign p_i_swatch_name = value | strip | strip_html | strip_newlines | handleize %}
              {% assign p_i_class_name = "color-swatch-" | append: p_i_swatch_name %}
                <div class="product-item__color-wrap">
                  <input
                    class="product-item__color-input"
                    type="radio"
                    id="{{ block_p.id }}-option{{ option.position }}-{{ value }}"
                    name="options[{{ option.name }}]"
                    value="{{ value }}"
                    data-pi-option-value="{{ value }}"
                    data-pi-option-handle="{{ p_i_swatch_name }}"
                    data-pi-option-name={{ name_clean }}
                    data-pi-option-index="{{ option.position }}"
                    {% if forloop.first %}checked{% endif %} />
                  <label
                    class="product-item__color-label {{ p_i_class_name }}"
                    for="{{ block_p.id }}-option{{ option.position }}-{{ value }}"
                    title="{{ value | remove: '_' }}">
                    <span {% comment %} class="hide" {% endcomment %}>{{ value }}</span>
                  </label>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="product-item__option" data-pi-option="{{ forloop.index }}">
              {% for value in option.values %}
                <span class="product-item__value-wrap">
                  <input
                    class="product-item__value-input"
                    type="radio"
                    id="{{ block_p.id }}-option{{ option.position }}-{{ value }}"
                    name="options[{{ option.name }}]"
                    value="{{ value }}"
                    data-pi-option-value="{{ value }}"
                    data-pi-option-name="{{ name_clean }}"
                    data-pi-option-index="{{ option.position }}"
                    {% if forloop.first %}checked{% endif %} />
                  <label
                    class="product-item__value-label"
                    for="{{ block_p.id }}-option{{ option.position }}-{{ value }}">
                    {{ value }}
                  </label>
                </span>
              {% endfor %}
            </div>
          {% endif %}

        {% endfor %}
      </div>
      {% endunless %}

      <div class="product-item__submit-wrap">
        <button
          type="submit"
          class="product-item__submit-btn"
          data-pi-submit
          data-add-to-cart
          {% unless block_p_def_v.available %}disabled="disabled"{% endunless %}
          >
          <span class="product-item__submit-price" data-pi-submit-price>
            {{ block_p_def_v.price | money | remove: ".00" | strip }}
          </span>
          <span class="product-item__submit-text" data-pi-submit-text>
            {% if block_p_def_v.available %}
              {{ 'products.product.add_to_cart' | t }}
            {% else %}
              {{ 'products.product.sold_out' | t }}
            {% endif %}
          </span>
        </button>
      </div>
    </div>

  {% endform %}

  {% if block_p != empty and block_p.has_only_default_variant == false %}
    <script type="application/json" data-product-json>
      {
        "variants": [
          {% for block_p_j_v in block_p.variants %}
            {
              "id": {{ block_p_j_v.id | json }},
              "price": {{ block_p_j_v.price | json }},
              "compare_at": {{ block_p_j_v.compare_at_price | json }},
              "available": {{ block_p_j_v.available | json }},
              "Option1": {{ block_p_j_v.option1 | json }},
              "Option2": {{ block_p_j_v.option2 | json }},
              "Option3": {{ block_p_j_v.option3 | json }}
            }{% unless forloop.last %},{% endunless %}
          {% endfor %}
        ]
      }
    </script>
  {% endif %}
</div>
