window.onload = function() {
  //make container changeable through the code in order to make the whole code work for product-item, not just for the pdp page

  var selectors = {
    unavailableVariants: "#unavailable-variant",
    unavailableNotices: "#unavailable-notify",
    availabilityData: "#all-products-availability",
    country: "#country-hidden",
    geoInfo: "#geo-location-info",
    submitButton: (container) => `${container} [data-submit-button]`,
    submitButtonText: (container) => `${container} [data-submit-button-text]`,
    soldOutForm: (container) => `${container} [data-sold-out-mail]`,
    idSelect: (container) => `${container} select[name="id"]`,
    currentOption: (container) =>
      `${container} select[name="id"] option:selected`,
    optionByVariant: (container, variant) =>
      `${container} select[name="id"] option[value="${variant}"]`,
    pdpInputByVariantId: (container, id) =>
      `${container} [data-geo-specific-variant="${id}"]`,
    shippingNote: (container) => `${container} [data-pdp-shipping-note]`,
    productId: (container) => `${container} [data-current-product-id]`,
    atcAdd: "[data-atc-add]",
    atcCurrent: "[data-atc-current]",
    notifyMe: {
      notice: (container) => `${container} [data-sold-out-notice]`,
      submit: (container) => `${container} [data-submit-sold-out-btn]`,
      form: (container) => `${container} [data-sold-out-form]`,
      input: (container) => `${container} [data-sold-out-input]`,
      message: (container) => `${container} [data-sold-out-message]`,
    },
  };

  var attributes = {
    shipping: "data-ship-message",
  };

  var geoLocationComplete = new Event("geoLocationComplete");

  function submitButtonLoaded() {
    $(selectors.submitButton).removeClass("loading");
  }

  // change the add to cart depending on product availability
  function renderSubmitButton(id) {
    var container = "";
    var pid = 0;
    var isPdp = false;
    if (id) {
      container = `[data-single-product="${id}"]`;
      pid = id;
    } else {
      container = `[data-section-type="product"]`;
      pid = $(`[data-section-type="product"]`).data("pdp-product-id");
      isPdp = true;
    }

    if (!pid || !container) {
      return null;
    }
    var $submitButton = $(selectors.submitButton(container));
    var $submitButtonText = $(selectors.submitButtonText(container));
    var availabilityData = JSON.parse($(selectors.availabilityData).val());
    console.log("availabilityData", availabilityData);
    console.log("availabilityData id", pid);
    console.log("availabilityData product", availabilityData[pid]);
    var uVariants = availabilityData[pid].out_of_stock;
    var uNotices = availabilityData[pid].notify;
    var currentVariant = $(selectors.idSelect(container)).val();
    var shippingMessage = $(selectors.currentOption(container)).attr(
      attributes.shipping
    );
    var $atcBarButton = $(selectors.atcAdd);
    var $atcCurrent = $(selectors.atcCurrent);
    var $soldOutForm = $(selectors.soldOutForm(container));
    var $shippingNote = $(selectors.shippingNote(container));

    if (typeof shippingMessage !== "undefined") {
      $shippingNote.text(shippingMessage);
      $shippingNote.removeClass("hide");
    } else {
      $shippingNote.addClass("hide");
    }

    if (uVariants !== "") {
      var uVariantsSplit = uVariants.split(",");
      if ($.inArray(currentVariant, uVariantsSplit) !== -1) {
        //if current variant is unavailable
        $submitButton.attr("disabled", true);
        $atcCurrent.addClass("unavailable");
        $submitButtonText.text(theme.strings.unavailable);
        if (isPdp) {
          $atcBarButton.attr("disabled", true);
          $atcBarButton.text(theme.strings.soldOut);
          $atcBarButton.addClass("unavailable");
        }
      } else {
        //current variant is available
        $submitButton.removeAttr("disabled");
        $atcCurrent.removeClass("unavailable");
        $submitButtonText.text(theme.strings.addToCart);
        if (isPdp) {
          $atcBarButton.removeAttr("disabled");
          $atcBarButton.text(theme.strings.add);
          $atcBarButton.removeClass("unavailable");
        }
      }
    }

    if (uNotices !== "") {
      var uNoticesSplit = uNotices.split(",");
      if ($.inArray(currentVariant, uNoticesSplit) !== -1) {
        $soldOutForm.fadeIn();
      } else {
        $soldOutForm.fadeOut();
      }
    }
  }

  // get available variant
  function setUnavailableVariants(country, productId) {
    var cUrl = "/a/dyl/black-variants";
    $.ajax({
      url: cUrl,
      type: "GET",
      data: { country: country, product_id: productId },
      dataType: "json",
      success: function(response) {
        console.log("response: ", response);
        submitButtonLoaded();
        $(selectors.unavailableVariants).val(response.out_of_stock);
        $(selectors.unavailableNotices).val(response.nofify_order);
        var $variantMessages = response.black_order;

        console.log(
          "availabilityData: ",
          JSON.parse($(selectors.availabilityData).val())
        );

        for (let i = 0; i < response.out_of_stock.length; i++) {
          const oosVariant = response.out_of_stock[i];
          $(selectors.pdpInputByVariantId(oosVariant)).addClass("unavailable");
        }
        // set variant selector option attribute
        if ($variantMessages.length > 0) {
          $.each($variantMessages, function(i, variantMessage) {
            var variantMessageSegment = variantMessage.split(":");
            // set ship message attribute
            var variant = variantMessageSegment[0];
            var message = variantMessageSegment[1];
            var $selectorOption = $(selectors.optionByVariant(variant));
            $selectorOption.attr(attributes.shipping, message);
          });
        }
        renderSubmitButton();
      },
      error: function(jqXHR, textStatus, errorThrown) {
        submitButtonLoaded();
        console.log(textStatus, errorThrown);
      },
    });

    return $(selectors.unavailableVariants).val();
  }

  // get available variant
  function setAllUnavailableVariants(country) {
    if (!country) {
      return null;
    }
    var cUrl = `/a/dyl/products-availability-by-country?country=${country}`;
    $.ajax({
      url: cUrl,
      type: "GET",
      dataType: "json",
      success: function(response) {
        submitButtonLoaded();
        var $products = $("[data-single-product]");
        $(selectors.availabilityData).val(JSON.stringify(response));
        $products.each(function() {
          try {
            const $product = $(this);
            const pId = $product.data("single-product");
            const container = `[data-single-product="${pId}"]`;
            const productData = response[pId];
            for (let i = 0; i < productData.out_of_stock.length; i++) {
              const oosVariant = productData.out_of_stock[i];
              $(selectors.pdpInputByVariantId(container, oosVariant)).addClass(
                "unavailable"
              );
            }
            $.each(productData.back_order, function(i, variantMessage) {
              var variantMessageSegment = variantMessage.split(":");
              // set ship message attribute
              $(
                selectors.optionByVariant(container, variantMessageSegment[0])
              ).attr(attributes.shipping, variantMessageSegment[1]);
            });
          } catch (error) {
            console.log(error);
          }
        });
      },
      error: function(jqXHR, textStatus, errorThrown) {
        submitButtonLoaded();
        console.log(textStatus, errorThrown);
      },
    });

    return $(selectors.unavailableVariants).val();
  }

  function IsEmail(email) {
    var regex = /^([a-zA-Z0-9_\.\-\+])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
    return regex.test(email);
  }
  /*
  // Store Data Notify Me Subscribe
  $(selectors.notifyMe.submit).click(function() {
    theme.strings.sold_out_email_invalid;
    theme.strings.sold_out_email_confirm;
    var notifyMessage = $(selectors.notifyMe.message);
    notifyMessage.text("");
    var $customerEmail = $(selectors.notifyMe.input);
    if ($customerEmail.val() == "") {
      $customerEmail.focus();
      return false;
    } else {
      var customerEmail = $customerEmail.val();
      if (IsEmail(customerEmail)) {
        // send data
        var cUrl = "/a/dyl/notify-me-data";
        var country = $(selectors.country).val();
        var productId = $(selectors.productId).val();
        var variantId = $(selectors.idSelect).val();
        var geoInfo = $(selectors.geoInfo).val();
        $.ajax({
          url: cUrl,
          type: "GET",
          data: {
            email: customerEmail,
            country: country,
            product_id: productId,
            variant_id: variantId,
            geo_info: geoInfo,
          },
          dataType: "json",
          success: function(response) {
            $(selectors.notifyMe.notice).fadeOut(200);
            $(selectors.notifyMe.form).fadeOut(200);
            setTimeout(function() {
              notifyMessage.text(response.message);
              notifyMessage.fadeIn();
            }, 100);
          },
          error: function(jqXHR, textStatus, errorThrown) {
            console.log(textStatus, errorThrown);
          },
        });
      } else {
        $customerEmail.focus();
        notifyMessage.text(theme.strings.sold_out_email_invalid);
        notifyMessage.fadeIn();
      }
    }
  });
 */
  //Check visitor IP Location Function
  jQuery.ajax({
    url:
      "https://api.ipstack.com/check?access_key=c9ac55ecdf7513abc5581dd4c89b042b",
    dataType: "jsonp",
    success: function(location) {
      // If the visitor is browsing from US.
      var userGeo = `${location.ip}|${location.country_name}|${
        location.region_name
      }|${location.city}|${location.time_zone.id}|${location.country_code}|${
        location.region_code
      }`;
      $(selectors.geoInfo).val(userGeo);

      // country inventory
      var country4px = [
        "AU",
        "AT",
        "BE",
        "BN",
        "BG",
        "KH",
        "CY",
        "CZ",
        "DK",
        "EE",
        "FI",
        "FR",
        "DE",
        "GR",
        "HK",
        "HU",
        "IE",
        "IT",
        "JP",
        "LA",
        "LV",
        "LI",
        "LT",
        "LU",
        "MO",
        "MY",
        "MT",
        "MC",
        "NL",
        "NZ",
        "NO",
        "PH",
        "PL",
        "PT",
        "RO",
        "SG",
        "SK",
        "SI",
        "KR",
        "ES",
        "SE",
        "CH",
        "TW",
        "TH",
        "GB",
        "VN",
      ];

      if (location.country_code === "US") {
        $("body").addClass("location-us");
      } else if (location.country_code === "CA") {
        $("body").addClass("location-ca");
      } else {
        $("body").addClass("location-other");
      }

      // product page
      var sUrl = window.location.href;
      var productPage = false;

      // checking if we are on the product page
      if (sUrl.indexOf("/products/") != -1) {
        var productId = $("[data-pdp-product-id]").data("pdp-product-id");
        productPage = true;
      }

      // Function country inventory according to country
      if (location.country_code === "CA") {
        // 4PX - CA Country region
        $(selectors.country).val("ca");
        setAllUnavailableVariants("ca");
      } else if ($.inArray(location.country_code, country4px) != -1) {
        // 4PX - HK Country region
        $(selectors.country).val("px");
        setAllUnavailableVariants("px");
      } else if ($.inArray("usa") != -1) {
        // Senyx USA Country region
        // other is correct for some reason
        $(selectors.country).val("other");
        setAllUnavailableVariants("usa");
      } else {
        $(selectors.country).val("other");
        setAllUnavailableVariants("other");
      }
      /* if (productPage) {
        console.log("productId", productId);
        // Function country inventory according to country
        if (location.country_code === "CA") {
          // 4PX - CA Country region
          $(selectors.country).val("ca");
          setUnavailableVariants("ca", productId);
        } else if ($.inArray(location.country_code, country4px) != -1) {
          // 4PX - HK Country region
          $(selectors.country).val("px");
          setUnavailableVariants("px", productId);
        } else {
          // Senyx USA Country region
          $(selectors.country).val("other");
          setUnavailableVariants("other", productId);
        }
      }
      */
      document.dispatchEvent(geoLocationComplete);
    },
  });

  document.addEventListener("productFormOptionChange", renderSubmitButton);
};
